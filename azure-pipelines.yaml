name: "build-n-test"
trigger:
  branches:
    include:
      - "master"

variables:
  artifactDir: $(System.DefaultWorkingDirectory)/artifacts

jobs:
  - job: "release_from_master"
    condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')
    timeoutInMinutes: 0
    pool:
      vmImage: "ubuntu-16.04"
    steps:
      - checkout: self
        clean: true
        lfs: true
        submodules: recursive
        persistCredentials: true
      - task: Docker@2
        displayName: ubuntu
        inputs:
          command: buildAndPush
          Dockerfile: docker/ubuntu
          buildContext: "."
          containerRegistry: airmapreg.acr
          repository: platform-sdk.ubuntu
          tags: |
            $(Build.SourceVersion)
      - bash: |
          chmod +x ./docker/extract_artifacts.sh
          ./docker/extract_artifacts.sh airmapreg.azurecr.io/platform-sdk.ubuntu:$(Build.SourceVersion) $(artifactDir)
      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: $(artifactDir)
          artifactName: airmap-platform-sdk-releases
  - job: "l4t_release"
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
    dependsOn: []
    timeoutInMinutes: 0
    pool:
      vmImage: "ubuntu-20.04"
    steps:
      - checkout: self
        clean: true
        lfs: true
        submodules: recursive
        persistCredentials: true
      - bash:  |
          chmod +x ./tools/l4t/build-docker-image.sh
          ./tools/l4t/build-docker-image.sh
          chmod +x ./docker/extract_artifacts.sh
          ./docker/extract_artifacts.sh airmapreg.azurecr.io/platform-sdk.l4t:$(Build.SourceVersion) $(artifactDir)
      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: $(artifactDir)
          artifactName: airmap-platform-sdk-releases
  - job: "github_release"
    condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')
    pool:
      vmImage: "ubuntu-20.04"
    dependsOn:
      #- l4t_release
      - release_from_master
    steps:
      - task: DownloadPipelineArtifact@2
        displayName: 'Gather Build Artifacts'
        inputs:
          artifact: 'airmap-platform-sdk-releases'
          path: $(Build.ArtifactStagingDirectory)
      - bash: |
          set -eo pipefail
          curl -fsL https://github.com/cli/cli/releases/download/v1.9.2/gh_1.9.2_linux_amd64.tar.gz | tar -xzf - --no-anchored gh --strip-components 2
          chmod a+x gh
          gh config set prompt disabled
          gh auth login --with-token $(GITHUB_TOKEN)
            # assume release version is most recent existing tag in repo
          VERSION=$(git describe --abbrev=0 --tags)
          ./gh release upload --repo=airmap/platform-sdk $(VERSION) airmap-platform-sdk-*.deb
        condition: ne(variables['Build.SourceBranch'], 'refs/heads/master')
        displayName: "Create GitHub release"
        env:
          GITHUB_TOKEN: $(GITHUB_TOKEN)

  - job: "pr"
    condition: eq(variables['Build.SourceBranch'], 'refs/heads/master')
    timeoutInMinutes: 0
    pool:
      vmImage: "ubuntu-16.04"
    steps:
      - checkout: self
        clean: true
        lfs: true
        submodules: recursive
        persistCredentials: true
      - task: Docker@2
        displayName: ubuntu
        inputs:
          command: build
          Dockerfile: docker/ubuntu
          buildContext: "."
          containerRegistry: airmapreg.acr
          repository: platform-sdk.ubuntu
          tags: $(Build.SourceVersion)
      - task: Docker@2
        displayName: centos
        inputs:
          command: build
          Dockerfile: docker/centos
          buildContext: "."
      - task: Docker@2
        displayName: android
        inputs:
          command: build
          Dockerfile: docker/android
          buildContext: "."
